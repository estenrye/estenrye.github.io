<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Rook/Ceph Background Research" /><meta property="og:locale" content="en" /><meta name="description" content="Rook Implementation Research Notes" /><meta property="og:description" content="Rook Implementation Research Notes" /><link rel="canonical" href="https://estenrye.github.io/posts/researching-rook/" /><meta property="og:url" content="https://estenrye.github.io/posts/researching-rook/" /><meta property="og:site_name" content="Esten.Rye.Ninja Documentation" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-04T04:15:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Rook/Ceph Background Research" /><meta name="twitter:site" content="@csciborg" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-10T12:41:09-05:00","datePublished":"2022-09-04T04:15:00-05:00","description":"Rook Implementation Research Notes","headline":"Rook/Ceph Background Research","mainEntityOfPage":{"@type":"WebPage","@id":"https://estenrye.github.io/posts/researching-rook/"},"url":"https://estenrye.github.io/posts/researching-rook/"}</script><title>Rook/Ceph Background Research | Esten.Rye.Ninja Documentation</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Esten.Rye.Ninja Documentation"><meta name="application-name" content="Esten.Rye.Ninja Documentation"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://www.gravatar.com/avatar/fda3bf251c8a938e0c403b51559bf884?s=400" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Esten.Rye.Ninja Documentation</a></div><div class="site-subtitle font-italic">Documentation for my Home Lab</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/estenrye" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/csciborg" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/estenrye" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Rook/Ceph Background Research</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Rook/Ceph Background Research</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662282900" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 4, 2022 </em> </span> <span> Updated <em class="" data-ts="1662831669" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 10, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/estenrye">Esten Rye</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1275 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h1 id="rook-implementation-research-notes">Rook Implementation Research Notes</h1><h2 id="videos"><span class="mr-2">Videos</span><a href="#videos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://www.youtube.com/watch?v=wIRMxl_oEMM">YouTube - Getting Started with Rook</a><ul><li>The Linux Foundation<li>January 07, 2020<li>Covers:<ul><li>Installing rook<li>Setting up device usage<li>Setting up storage class<li>Setting up PVC</ul></ul><li><a href="https://www.youtube.com/watch?v=yeAlzSp6yaE">YouTube - Tuesday Tech Tip - Intro to Ceph Clustering Part 1 - When to Consider It</a><ul><li>45 Drives<li>May 26, 2020</ul><li><a href="https://www.youtube.com/watch?v=HJivYTJ9Y54">YouTube - Tuesday Tech Tip - Intro to Ceph Clustering Part 2 - How Ceph Works</a><ul><li>45 Drives<li>June 02, 2020</ul><li><a href="https://www.youtube.com/watch?v=L5ug8UIs4tI">YouTube - Tuesday Tech Tip - Intro to Ceph Clustering Part 3 - Data Security</a><ul><li>45 Drives<li>June 09, 2020</ul><li><a href="https://www.youtube.com/watch?v=jBWVcJYNjeA">YouTube - Tuesday Tech Tip - Intro to Ceph Clustering Part 4 - Self Balancing and Self Healing</a><ul><li>45 Drives<li>June 16, 2020</ul><li><a href="https://www.youtube.com/watch?v=dA29dIK6g5o">YouTube - Intro to Rook: Storage for Kubernetes</a><ul><li>Jared Watts, Upbound &amp; Alexander Trost, Cloudical<li>September 04, 2020</ul><li><a href="https://www.youtube.com/watch?v=v1u6bPM4SQU">YouTube - Performance Optimization – Rook on Kubernetes</a><ul><li>Mark Darnell &amp; Ryan Tidwell, SUSE<li>September 04, 2020</ul><li><a href="https://www.youtube.com/watch?v=Uvbp3mtOltw">YouTube - Getting started with ceph storage cluster setup</a><ul><li>Daniel Persson<li>October 25, 2020</ul><li><a href="https://www.youtube.com/watch?v=SLld70mnpbo&amp;list=PL0q6mglL88AN9LGNfmEhu2fxZ_DNm5nZA">YouTube - Tuesday Tech Tip - Ceph Deployment Tools</a><ul><li>45 Drives<li>November 17, 2020</ul><li><a href="https://www.youtube.com/watch?v=j86OXjC1Jr8">YouTube - Rook: Intro and Ceph Deep Dive</a><ul><li>Blaine Gardner, Red Hat / Satoru Takeuchi, Cybozu, Inc.<li>May 14, 2021</ul><li><a href="https://www.youtube.com/watch?v=ZsQp1vmn22M">YouTube - Tuesday Tech Tip - The Simplest Way to Build a Ceph Cluster</a><ul><li>45 Drives<li>August 17, 2021</ul><li><a href="https://www.youtube.com/watch?v=0SOCWLmSrQs">YouTube - Kubernetes Fortnight: Solving storage in Kubernetes with the Rook operator</a><ul><li>Platform9 Systems, Inc.<li>Chris Jones / Anup Barve<li>August 19, 2021<li>Covers:<ul><li>High Level Overview and Key topics around Rook and Ceph</ul></ul><li><a href="https://www.youtube.com/watch?v=cR-s26Zzx4Y">YouTube - ROOK – Ceph Backed Object Storage for Kubernetes Install and Configure</a><ul><li>Anthony Spiteri<li>September 03, 2021</ul><li><a href="https://www.youtube.com/watch?v=7C9HI_f0bBo">YouTube - Tuesday Tech Tip - Tuning and Benchmarking for your Workload with Ceph</a><ul><li>Mitch / 45Drives<li>October 26, 2021<li>Covers:<ul><li>Performance Tuning<ul><li>IOPS and Throughput Benchmarks on Underlying Disks<li>Network Performance Testing with iPerf<li>Latency tests between the nodes.<li>tuned for getting servers performing with lowest possible latency</ul></ul></ul><li><a href="https://www.youtube.com/watch?v=VBVVqiKvlCI">YouTube - Rook: Intro and Ceph Deep Dive</a><ul><li>Travis Nielsen, Sebastien Han, Blaine Gardner &amp; Satoru Takeuchi<li>October 29, 2021</ul><li><a href="https://www.youtube.com/watch?v=ENsfa8WB6EI">YouTube - How to set up a cluster with CephAdm</a><ul><li>Daniel Persson<li>January 17, 2022</ul><li><a href="https://www.youtube.com/watch?v=VSjcm82l5UA">YouTube - Introduction to Rook</a><ul><li>Red Hat Developer<li>Travis Nielson / Rook Maintainer / Red Hat<li>May 10, 2022</ul><li><a href="https://www.youtube.com/watch?v=-4usMK00qW0">YouTube - Rook in the cloud or on-prem?</a><ul><li>Red Hat Developer<li>Travis Nielson / Rook Maintainer / Red Hat<li>May 10, 2022</ul><li><a href="https://www.youtube.com/watch?v=1SF8sTsMGYY">YouTube - Getting started with Rook</a><ul><li>Red Hat Developer<li>Travis Nielson / Rook Maintainer / Red Hat<li>May 10, 2022</ul><li><a href="https://www.youtube.com/watch?v=DYofW39Q5Z8">YouTube - Installing Rook in an AWS cluster</a><ul><li>Red Hat Developer<li>Travis Nielson / Rook Maintainer / Red Hat<li>May 10, 2022</ul></ul><h2 id="tutorials"><span class="mr-2">Tutorials</span><a href="#tutorials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://platform9.com/learn/tutorials/rook-using-ceph-csi">How to Deploy Rook with Ceph as a Storage Backend for your Kubernetes Cluster using CSI</a></ul><h2 id="blog-posts"><span class="mr-2">Blog Posts</span><a href="#blog-posts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://blog.kintone.io/entry/2020/09/18/175030">Production-grade Deployment of PVC-based Rook/Ceph Cluster</a><li><a href="https://access.redhat.com/sites/default/files/attachments/201501-perf-brief-low-latency-tuning-rhel7-v2.1.pdf">RedHat article on low-latency performance tuning</a></ul><h2 id="questions"><span class="mr-2">Questions</span><a href="#questions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>How can I set up encryption at rest in Ceph?<li>How do I craft a backup strategy for ceph?<li>Can backup be managed at the Ceph level?</ul><h2 id="fun-tools-i-found-along-the-way"><span class="mr-2">Fun tools I found along the way</span><a href="#fun-tools-i-found-along-the-way" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://asciinema.org/">asciinema</a> (Terminal Recording Tool)<ul><li><a href="https://github.com/asciinema/asciinema-server">asciinema-server</a> for self-hosted publishing<li><a href="https://github.com/asciinema/asciinema-player#self-hosting-quick-start">asciinema-player</a> for embedding in a website</ul></ul><h1 id="benchmarking">Benchmarking</h1><h2 id="benchmark-disks-that-will-eventually-make-up-the-osds"><span class="mr-2">Benchmark disks that will eventually make up the OSDs</span><a href="#benchmark-disks-that-will-eventually-make-up-the-osds" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="iops-benchmark"><span class="mr-2">IOPS Benchmark</span><a href="#iops-benchmark" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First step is to get a baseline understanding of the disk’s IOPS.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nv">BLOCK_DEVICE</span><span class="o">=</span>/dev/sdl

<span class="c"># Get a baseline on the disk's IOPS</span>
fio <span class="nt">--filename</span><span class="o">=</span><span class="k">${</span><span class="nv">BLOCK_DEVICE</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--direct</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--fsync</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--rw</span><span class="o">=</span>randwrite <span class="se">\</span>
    <span class="nt">--bs</span><span class="o">=</span>4k <span class="se">\</span>
    <span class="nt">--numjobs</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--iodepth</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--runtime</span><span class="o">=</span>60 <span class="se">\</span>
    <span class="nt">--time_based</span> <span class="se">\</span>
    <span class="nt">--group_reporting</span> <span class="se">\</span>
    <span class="nt">--name</span><span class="o">=</span>4k-sync-write-test
</pre></table></code></div></div><p>Take Note of the IOPS returned. Track repeated benchmarks with the same model of drive over and over to get a good understanding of how the drive is going to perform, noting any variance between the tests. It’s important to ensure that the variance of the IOPS of the disks in the system is not wildly different between disks.</p><h3 id="throughput-benchmark"><span class="mr-2">Throughput Benchmark</span><a href="#throughput-benchmark" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next step is to run a throughput benchmark on each of the drives. The key metric in this test is the Bandwidth (BW) metric. Repeat this test for each drive.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">BLOCK_DEVICE</span><span class="o">=</span>/dev/sdl

fio <span class="nt">--filename</span><span class="o">=</span><span class="k">${</span><span class="nv">BLOCK_DEVICE</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--direct</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--fsync</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--rw</span><span class="o">=</span>write <span class="se">\</span>
    <span class="nt">--bs</span><span class="o">=</span>1M <span class="se">\</span>
    <span class="nt">--numjobs</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--iodepth</span><span class="o">=</span>1 <span class="se">\</span>
    <span class="nt">--runtime</span><span class="o">=</span>60 <span class="se">\</span>
    <span class="nt">--time_based</span> <span class="se">\</span>
    <span class="nt">--group_reporting</span> <span class="se">\</span>
    <span class="nt">--name</span><span class="o">=</span>1M--sync-throughput-test
</pre></table></code></div></div><h2 id="benchmark-the-network-that-our-storage-cluster-will-communicate-over"><span class="mr-2">Benchmark the network that our storage cluster will communicate over.</span><a href="#benchmark-the-network-that-our-storage-cluster-will-communicate-over" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Make sure the network bandwidth is where it should be. Ensure retransmission rate is not high and congestion window is not too small.</p><p>Select a node to be the server in this test.</p><h3 id="install-iperf3-on-client-and-server"><span class="mr-2">Install iperf3 on client and server</span><a href="#install-iperf3-on-client-and-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> iperf3
</pre></table></code></div></div><h3 id="on-the-server"><span class="mr-2">On the Server</span><a href="#on-the-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First we are going to configure iperf3 on the server to listen on port 5201.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">SERVER_IP_ADDRESS</span><span class="o">=</span>192.168.200.2

iperf3 <span class="nt">-B</span> <span class="k">${</span><span class="nv">SERVER_IP_ADDRESS</span><span class="k">}</span> <span class="nt">-s</span>
</pre></table></code></div></div><h3 id="on-the-client"><span class="mr-2">On the Client</span><a href="#on-the-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next we need to configure iperf3 on the client to connet to the server. Note that we are explictly telling iperf3 which interface we are using to perform the test. This is important because the ceph cluster may have multiple interfaces which may be configured for frontend/backend traffic.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">SERVER_IP_ADDRESS</span><span class="o">=</span>192.168.200.2
<span class="nv">CLIENT_IP_ADDRESS</span><span class="o">=</span>192.168.200.3

<span class="c"># Test from client ==&gt; server</span>
iperf3 <span class="nt">-B</span> <span class="k">${</span><span class="nv">CLIENT_IP_ADDRESS</span><span class="k">}</span> <span class="nt">-c</span> <span class="k">${</span><span class="nv">SERVER_IP_ADDRESS</span><span class="k">}</span>

<span class="c"># Test from server ==&gt; client</span>
iperf3 <span class="nt">-B</span> <span class="k">${</span><span class="nv">CLIENT_IP_ADDRESS</span><span class="k">}</span> <span class="nt">-c</span> <span class="k">${</span><span class="nv">SERVER_IP_ADDRESS</span><span class="k">}</span> <span class="nt">-R</span>
</pre></table></code></div></div><p>There are two metrics we are interested in looking at.</p><ul><li>Retransmission: the number of times the sender needed to resend the packet before it was actually accepted. Smaller numbers are better.<li>Congestion Window: the amount of data that can be sent without having to get an ACk sent back. Larger numbers are better, ideally around 1 MB.</ul><p>Repeat this test on all nodes and interfaces that will be part of the Ceph cluster.</p><h2 id="get-an-idea-of-any-packet-errors-or-drops"><span class="mr-2">Get an idea of any packet errors or drops.</span><a href="#get-an-idea-of-any-packet-errors-or-drops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>netstat <span class="nt">-i</span> | column <span class="nt">-t</span>
</pre></table></code></div></div><p>This will give us an overview of the following:</p><ul><li>RX-OK: Received packets that were OK.<li>RX-ERR: Any packets received that errored.<li>RX-DRP: Any packets that were dropped.<li>TX-OK: Sent packets that were OK.<li>TX-ERR: Any packets sent that errored.<li>TX-DRP: Any packets sent that dropped.</ul><p>It’s good to monitor these statistics over time to see if the network is seeing any kind of drops or issues.</p><h2 id="perform-a-ping-test-to-get-a-feel-for-latency-between-the-nodes"><span class="mr-2">Perform a ping test to get a feel for latency between the nodes.</span><a href="#perform-a-ping-test-to-get-a-feel-for-latency-between-the-nodes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">SERVER_IP_ADDRESS</span><span class="o">=</span>192.168.200.2

ping <span class="k">${</span><span class="nv">SERVER_IP_ADDRESS</span><span class="k">}</span>
</pre></table></code></div></div><p>Ceph performance hinges on network latency being as low as possible.</p><h1 id="tuning-the-system-for-low-latency">Tuning the system for low latency</h1><p>In this section we want to disable some of the deeper c-states (idle states) and tune the CPU’s p-states for peak performance and getting peak boost clocks.</p><p>Using the tuned tool we an set in place multiple, meaningful tunings by enabling specific tuning profiles. For Ceph, we want to use the network-latency profile.</p><h2 id="make-sure-bios-isnt-going-to-clobber-your-settings"><span class="mr-2">Make sure BIOS isn’t going to clobber your settings</span><a href="#make-sure-bios-isnt-going-to-clobber-your-settings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="using-tuned-to-tune-the-system"><span class="mr-2">Using tuned to tune the system</span><a href="#using-tuned-to-tune-the-system" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c"># List tuning profiles</span>
tuned-adm list

<span class="c"># take a look at latency-performance configurations</span>
egrep <span class="nt">-v</span> <span class="s1">'^$|^\#|\['</span> /usr/lib/tuned/latency-performance/tuned.conf

<span class="c"># take a look at the network-latency configurations</span>
egrep <span class="nt">-v</span> <span class="s1">'^$|^\#|\['</span> /usr/lib/tuned/network-latency/tuned.conf

<span class="c"># set network-latency as the active profile.</span>
tuned-adm profile network-latency

<span class="c"># confirm network-latency profile is the active profile</span>
<span class="nb">cat</span> /etc/tuned/active_profile
</pre></table></code></div></div><h2 id="verify-the-tuning-profile-has-been-applied"><span class="mr-2">Verify the tuning profile has been applied</span><a href="#verify-the-tuning-profile-has-been-applied" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Make sure after applying the tuned profile and restarting the machine that all of the CPU cores are 100% in the C1 state and not in any of the deeper c-states which cause additional latency, reduce the impact of power management, reduce task migrations and reduce the amount of outstanding dirty pages kept in memory.</p><p>These changes will result in a higher power draw!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>turbostat <span class="nb">sleep </span>5
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/homelab/'>homelab</a>, <a href='/categories/rook/'>rook</a>, <a href='/categories/storage/'>storage</a>, <a href='/categories/baremetal/'>baremetal</a>, <a href='/categories/kubernetes/'>kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cd-homelab/" class="post-tag no-text-decoration" >cd-homelab</a> <a href="/tags/work-in-progress/" class="post-tag no-text-decoration" >work-in-progress</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Rook/Ceph%20Background%20Research%20-%20Esten.Rye.Ninja%20Documentation&url=https%3A%2F%2Festenrye.github.io%2Fposts%2Fresearching-rook%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Rook/Ceph%20Background%20Research%20-%20Esten.Rye.Ninja%20Documentation&u=https%3A%2F%2Festenrye.github.io%2Fposts%2Fresearching-rook%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Festenrye.github.io%2Fposts%2Fresearching-rook%2F&text=Rook/Ceph%20Background%20Research%20-%20Esten.Rye.Ninja%20Documentation" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Festenrye.github.io%2Fposts%2Fresearching-rook%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/soc2-compliance/">Learning About SOC2</a><li><a href="/posts/setting-up-multi-cluster-monitoring/">Setting up Multicluster Monitoring</a><li><a href="/posts/invoicing-software-for-family-tech-services/">Invoicing my Family - Tool Evaluation</a><li><a href="/posts/obs-streaming-configuration/">OBS Streaming Configuration</a><li><a href="/posts/teaching-my-daughter-to-code-part-1/">Teaching my Daughter to Code - Part 1</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cd-homelab/">cd-homelab</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/argocd/">argocd</a> <a class="post-tag" href="/tags/automate-someday/">automate-someday</a> <a class="post-tag" href="/tags/continuous-delivery/">continuous-delivery</a> <a class="post-tag" href="/tags/work-in-progress/">work-in-progress</a> <a class="post-tag" href="/tags/cortex/">cortex</a> <a class="post-tag" href="/tags/vs-code-server/">VS-Code-Server</a> <a class="post-tag" href="/tags/auditing/">auditing</a> <a class="post-tag" href="/tags/bare-metal/">bare-metal</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/researching-ha-ldap-for-airgap-environment/"><div class="card-body"> <em class="small" data-ts="1662812040" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuring Highly Available LDAP in an Airgapped Environment</h3><div class="text-muted small"><p> Open Questions Should I host my LDAP services on the Bare Metal Kubernetes controlplane nodes? Should I host LDAP services in my Kubernetes Cluster, rather than as a systemd service? If I h...</p></div></div></a></div><div class="card"> <a href="/posts/researching-centralized-logging/"><div class="card-body"> <em class="small" data-ts="1662812040" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuring Centralized Logging in an Airgapped Environment</h3><div class="text-muted small"><p> Open Questions What open-source log aggregation software should I use? Elastic-Fluent-Kibana (EFK)? Grafana Loki? What system logs are important to collect? Whic...</p></div></div></a></div><div class="card"> <a href="/posts/configure-aws-saml-auth-with-jumpcloud-sso/"><div class="card-body"> <em class="small" data-ts="1662714840" data-df="ll" > Sep 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuring AWS SSO with JumpCloud SAML Integration</h3><div class="text-muted small"><p> Prerequisites Sign up for a free JumpCloud Account Sign up for a free AWS Account After signing up for AWS, note your AWS Account Number. Define a Naming Convention for custom user attrib...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/branding-sslip-to-cloudfare-dns-subdomain/" class="btn btn-outline-primary" prompt="Older"><p>Branding sslip.io to a Cloudflare hosted DNS Subdomain</p></a> <a href="/posts/research-cell-booster/" class="btn btn-outline-primary" prompt="Newer"><p>Cell Booster Research</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cd-homelab/">cd-homelab</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/argocd/">argocd</a> <a class="post-tag" href="/tags/automate-someday/">automate-someday</a> <a class="post-tag" href="/tags/continuous-delivery/">continuous-delivery</a> <a class="post-tag" href="/tags/work-in-progress/">work-in-progress</a> <a class="post-tag" href="/tags/cortex/">cortex</a> <a class="post-tag" href="/tags/vs-code-server/">VS-Code-Server</a> <a class="post-tag" href="/tags/auditing/">auditing</a> <a class="post-tag" href="/tags/bare-metal/">bare-metal</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://www.linkedin.com/in/estenrye">Esten Rye</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
